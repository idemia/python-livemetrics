<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <meta name="description" content="Dashboard">

  <!-- https://code.jquery.com/ -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.css">

  <!-- https://apexcharts.com/ -->
  <link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"/>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<body>
  <style>

#title {
  text-align: center;
}

/* For status */
.status_ok {
  color: green;
  font-size: 300%;
}

.status_ko {
  color: red;
  font-size: 300%;
}

.centered {
  text-align: center;
  vertical-align: middle;
  line-height: 143px;
}

.row-label {
  font-size: 170%;
}

td h4 {
  text-align: center;
}

/* For simple values */
.value-value {
  font-family: sans-serif;
  font-size: 130%;
  font-weight: bold;
}

.gauge-canvas {
  top: 0px;
  position: relative;
}

.histo-canvas {
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

.histo-text {
  vertical-align: text-top;
  margin: 10px;
}

.gauge-text {
  position: relative;
  top: -10px; left: 0; right: 0;
  text-align: center; font-size: 1em; font-weight: bold;
  color: black; font-family: 'Amaranth', sans-serif;
}  

.gauge-sparkline {
  position: relative;
  top: 0px; left: 0; right: 0;
}  

.thumbnail {
    padding: 1px;
    margin-bottom: 0px;
}
    
.h1, .h2, .h3, .h4, h1, h2, h3, h4 {
    margin-top: 1px;
    margin-bottom: 0px;
}

td {
  vertical-align: top;
  padding: 5px;
  }

.number {
  text-align: right;
}

.tile {
    margin-right: 10px;
    margin-left: 10px;
    background-color: #fff;
    border-color: #ddd;
    border-width: 1px;
}
  
.panel-body {
    padding: 2px;
}

.panel-heading {
    padding: 2px 3px;
}
  
.panel-primary > .health_ok {
  background-color: #1a961a;
}

.panel-primary > .health_ko {
  background-color: #9c2a2a;
}
  </style>
  <script type="text/javascript">
  
  $( function(){

    // TODO adjust frequency on the number of charts in the dashboard
    setInterval(refresh_values,5000);

    {% for R in config.rows %}
      {% for C in R.cells %}
        init_{{C.id}}();
      {% endfor %}
    {% endfor %}

    refresh_values();
  });
  
  var $mpoints_max = 50;
  function refresh_values() {
    {% for R in config.rows %}
      {% for C in R.cells %}
        {% if C.type == 'label' %}
        {% elif C.type =='empty' %}
        {% else %}
//        update_{{C.id}}(10,true);
          $.get("all", {server: {{C.server|server_to_list}} }, function(stats,status) {
            update_{{C.id}}(stats,status);
          }).fail(function() {
            update_{{C.id}}(null,false);
          });
        {% endif %}
      {% endfor %}
    {% endfor %}
  }

  function conv(val,factor) {
    if (factor.slice(0,1)=='*') {
      return val * factor.slice(1);
    }
    if (factor.slice(0,1)=='/') {
      return val / factor.slice(1);
    }
  }

  function reduce(vals,ope) {
    if (!Array.isArray(vals)) {
      return vals;
    }

    s = 0;
    m = NaN;
    M = NaN;
    for (val of vals) {
      s += val;
      if (val>M || isNaN(M)) {
        M = val;
      }
      if (val<m || isNaN(m)) {
        m = val;
      }
    }
    if (ope=="average") {
      return s / vals.length;
    }
    if (ope=="sum") {
      return s;
    }
    if (ope=="min") {
      return m;
    }
    if (ope=="max") {
      return M;
    }
    return 0;
  }

  /* Init and update function */
  {% for R in config.rows %}
    {% for C in R.cells %}

      /* Global vars */
      {% if C.type == 'status' %}
      {% elif C.type == 'value' %}
      {% elif C.type == 'gauge' %}

        var ${{C.id}}_gauge = null;
        var ${{C.id}}_line_gauge = null;
        var $mpoints_{{C.id}}_gauge = [null,null,null,null,null];

      {% elif C.type == 'histogram' %}
        var ${{C.id}}_histo = null;
      {% endif %}

      /* Init function */
      function init_{{C.id}}() {
        {% if C.type == 'status' %}
        {% elif C.type == 'value' %}
        {% elif C.type == 'gauge' %}
          // TODO: Move label in a text area below the sparkline
          var options = {
            series: [{
              name: "{{C.label}}",
              data: $mpoints_{{C.id}}_gauge
            }],
            chart: {
              type: 'area',
              width: $mpoints_max*2,
              height: 40,
              sparkline: {
                enabled: true
              },
              animations: {
                enabled: false
              }
            },
            stroke: {
              curve: 'smooth',
              width: 2
            },
            fill: {
              opacity: 0.3,
              type: 'solid'
            },
            yaxis: {
              show: false,
              min: 0
              // max: {{C.max}}
            },
            colors: ["{{C.color|default('#C0D0F0')}}"]
          };


          ${{C.id}}_line_gauge = new ApexCharts(document.querySelector("#line-{{C.id}}-gauge"), options);
          ${{C.id}}_line_gauge.render();

          // The gauge it self
          {% set label = C.label ~ " (" ~ C.unit ~ ")" %}
          var options = {
            series: [67],
            chart: {
              height: 170,
              type: 'radialBar',
              offsetY: 0,
              animations: {
                enabled: false
              }
            },
            plotOptions: {
              radialBar: {
                startAngle: -125,
                endAngle: 125,
                dataLabels: {
                  name: {
                    fontSize: '16px',
                    color: 'black',
                    offsetY: 50
                  },
                  value: {
                    offsetY: -15,
                    fontSize: '12px',
                    color: 'black',
                    formatter: function (val) {
                      return (val/100*{{C.max|default(25000)}}).toFixed(0);
                    }
                  }
                }
              }
            },
            fill: {
              type: 'gradient',
              gradient: {
                shade: 'dark',
                shadeIntensity: 0.15,
                inverseColors: false,
                opacityFrom: 1,
                opacityTo: 1,
                colorStops: [ [ {
                    offset: 0,
                    color: '{{C.gauge_color|default("blue")}}',
                    opacity: 1
                    },
                  ]
                ],
              },
            },
            labels: ['{{label|truncate(10)}}'],  
          };

          ${{C.id}}_gauge = new ApexCharts(document.querySelector("#canvas-{{C.id}}-gauge"), options);
          ${{C.id}}_gauge.render();
        {% elif C.type == 'histogram' %}

          var options = {
            series: [
            {
              type: 'boxPlot',
              data: [
                {
                  x: '',
                  y: [54, 66, 69, 75, 88]
                }
                ]
              }
            ],
            chart: {
              type: 'boxPlot',
              height: 143,
              width: 110,
              animations: {
                enabled: false
              },
              toolbar: {show:false},
            },
            title: {
              show:false,
            },
            plotOptions: {
              boxPlot: {
                colors: {
                  lower: '{{C.median_color|default("rgba(255,0,0,0.5)")}}',
                  upper: '{{C.color|default("rgba(0,0,255,0.5)")}}'
                }
              }
            },
            yaxis: {
              show: true,
              forceNiceScale: true,
              decimalsInFloat: 0,
              labels: {
                style: {
                  fontSize: "6pt"
                }
              }
            },
            legend: {show: false},
          };

          ${{C.id}}_histo = new ApexCharts(document.querySelector("#chart-{{C.id}}-histo"), options);
          ${{C.id}}_histo.render();

        {% endif %}
      }

      /* Update function */
      function update_{{C.id}}(stats,status) {
        {% if C.type == 'status' %}
          var obj = document.getElementById("status-{{C.id}}");
          if (status==true || status=='success') {
            obj.className = "far fa-thumbs-up status_ok";
          } else {
            obj.className = "far fa-thumbs-down status_ko";
          }
        {% elif C.type == 'value' %}
          // Provide default values if metric does not exist yet
          if (stats==null) {
            stats = 0;
          }

          var V = reduce(stats,"{{C.operator|default("sum")}}");
          V = conv(V,"{{C.factor|default("*1")}}");
          {% if C.precision is defined %}
            if(!isNaN(V)) {
              V = V.toFixed({{C.precision}});
            }
          {% endif %}
          const obj_{{C.id}} = document.getElementById("value-{{C.id}}");
          obj_{{C.id}}.innerHTML = V;
        {% elif C.type == 'gauge' %}

          var value = conv(reduce(stats,"{{C.operator|default("sum")}}"),"{{C.factor|default("*1")}}");

          $mpoints_{{C.id}}_gauge.push(value);
          if ($mpoints_{{C.id}}_gauge.length > $mpoints_max) {
            $mpoints_{{C.id}}_gauge.splice(0,1);
          }

          ${{C.id}}_line_gauge.updateSeries([{
              data: $mpoints_{{C.id}}_gauge
            }]);

          ${{C.id}}_gauge.updateSeries([Math.min(value*100/{{C.max|default(25000)}}, 100)]);
        {% elif C.type == 'histogram' %}
          // Provide default values if histograms does not exist yet
          if (stats==null) {
            stats = {"quantiles": {"0.05": 0.0, "0.25": 0.0, "0.75": 0.0, "0.95": 0.0, "0.5": 0.0}};
          }

          ${{C.id}}_histo.updateSeries( [
            {
              type: 'boxPlot',
              data: [
                {
                  x: '',
                  y: [
                    conv(stats.quantiles[0.05],"{{C.factor|default("*1")}}"),
                    conv(stats.quantiles[0.25],"{{C.factor|default("*1")}}"),
                    conv(stats.quantiles[0.5],"{{C.factor|default("*1")}}"),
                    conv(stats.quantiles[0.75],"{{C.factor|default("*1")}}"),
                    conv(stats.quantiles[0.95],"{{C.factor|default("*1")}}")
                  ]
                }
                ]
              }
            ]);

        {% endif %}
      }
    {% endfor %}
  {% endfor %}

  </script>

<h2 id="title">{{config.title}}</h2>

<table>

  {% for R in config.rows %}

  <tr>

    {% for C in R.cells %}
      <td>
          {% if C.type == 'empty' %}

            <span style="display: inline-block;">
              <div class="centered">
                  <div style="height: 143px; width: 100px;">
                      <span class="row-label">&nbsp;</span>
                  </div>
              </div>
              <div>
                  <h4>&nbsp;</h4>
              </div>
            </span>
  
          {% elif C.type == 'label' %}

          <span style="display: inline-block;">
            <div class="centered">
                <div style="height: 143px; width: 100px;">
                    <span class="row-label">{{C.label}}</span>
                </div>
            </div>
            <div>
                <h4>&nbsp;</h4>
            </div>
          </span>

        {% elif C.type == 'status' %}

          <span style="display: inline-block;">
            <div class="thumbnail centered">
                <div style="height: 143px; width: 100px;">
                    <i id="status-{{C.id}}" class="far fa-thumbs-down status_ko"></i>
                </div>
            </div>
            <div>
                <h4 title="{{C.label}}">{{C.label|truncate(10)}}</h4>
            </div>
          </span>

        {% elif C.type == 'value' %}

          <span style="display: inline-block;">
            <div class="thumbnail centered">
              <div class="value-value" style="height: 143px; width: 100px;">
                <span id="value-{{C.id}}" style="color: {{C.color}}"></span><span style="color: {{C.color}}">&nbsp;{{C.unit}}</span>
              </div>
            </div>
            <div>
                <h4 title="{{C.label}}">{{C.label|truncate(10)}}</h4>
            </div>
          </span>
        
        {% elif C.type == 'gauge' %}

          <span style="display: inline-block;">
            <div id="canvas-{{C.id}}-gauge">Loading...</div>
            <div id="line-{{C.id}}-gauge">Loading..</div>
          </span>
      
        {% elif C.type == 'histogram' %}

          <span style="display: inline-block;">
            <div id="chart-{{C.id}}-histo"></div>
            <div>
                <h4 title="{{C.label}}">{{C.label|truncate(10)}}</h4>
            </div>
          </span>

        {% endif %}

      </td>

      {% endfor %}
    
    </tr>
    {% endfor %}

</table>

</body>
</html>
  